<main class="admin-page">
  <header class="topbar panel">
    <div>
      <p class="eyebrow">Ficticia</p>
      <h1>Admin Console</h1>
    </div>
    <div class="status">
      <span class="chip" [class.off]="!token">{{ token ? 'Authenticated' : 'No token' }}</span>
      <button type="button" class="secondary" (click)="toggleTheme()">
        {{ themeMode === 'dark' ? 'Light mode' : 'Dark mode' }}
      </button>
      <button type="button" class="secondary" (click)="logout()" [disabled]="busy || !token">Clear token</button>
    </div>
  </header>

  <section class="panel auth-panel">
    <h2>Connection</h2>
    <div class="grid three">
      <label>
        API base URL
        <input [(ngModel)]="apiBaseUrl" placeholder="(empty for Angular proxy)" />
      </label>
      <label>
        Email
        <input [(ngModel)]="email" placeholder="admin@ficticia.local" />
      </label>
      <label>
        Password
        <input [(ngModel)]="password" type="password" placeholder="Admin123!" />
      </label>
    </div>
    <div class="actions">
      <button type="button" (click)="login()" [disabled]="busy">Login + Load Data</button>
    </div>
  </section>

  <div class="toast-stack" aria-live="polite" aria-atomic="true">
    @for (note of notifications(); track note.id) {
      <article class="toast" [class.error]="note.type === 'error'">
        <p>{{ note.text }}</p>
        <button type="button" class="toast-close" (click)="dismissNotification(note.id)" aria-label="Dismiss notification">×</button>
      </article>
    }
  </div>

  <section class="layout-two">
    <article class="panel">
      <h2>People</h2>

      <div class="grid three">
        <label>
          Name
          <input [(ngModel)]="peopleSearch.name" />
        </label>
        <label>
          Identification
          <input [(ngModel)]="peopleSearch.identificationNumber" />
        </label>
        <label>
          Status
          <select [(ngModel)]="peopleSearch.isActive">
            <option value="">Any</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </label>
      </div>

      <div class="grid four">
        <label>
          Min age
          <input [(ngModel)]="peopleSearch.minAge" type="number" min="0" max="120" />
        </label>
        <label>
          Max age
          <input [(ngModel)]="peopleSearch.maxAge" type="number" min="0" max="120" />
        </label>
        <label>
          Page
          <input [(ngModel)]="peopleSearch.page" type="number" min="1" />
        </label>
        <label>
          Page size
          <input [(ngModel)]="peopleSearch.pageSize" type="number" min="1" max="100" />
        </label>
      </div>

      <div class="dynamic-filters">
        <p class="hint">Dynamic filters (`attr.&lt;key&gt;`)</p>
        @for (filter of peopleSearch.dynamicFilters; track $index) {
          <div class="filter-row">
            <input [(ngModel)]="filter.key" placeholder="key (e.g. diabetic)" />
            <input [(ngModel)]="filter.value" placeholder="value" />
            <button type="button" class="secondary" (click)="removeDynamicFilter($index)">Remove</button>
          </div>
        }
      </div>

      <div class="actions split">
        <button type="button" class="secondary" (click)="addDynamicFilter()">Add Filter</button>
        <button type="button" (click)="searchPeople()" [disabled]="busy || !token">Search</button>
      </div>

      <p class="hint">Total: {{ totalPeople }}</p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>ID</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (person of people; track person.id) {
              <tr [class.selected]="selectedPerson?.id === person.id">
                <td>{{ person.fullName }}</td>
                <td>{{ person.identificationNumber }}</td>
                <td>{{ person.age }}</td>
                <td>{{ genders[person.gender]?.label }}</td>
                <td>{{ person.isActive ? 'Active' : 'Inactive' }}</td>
                <td><button type="button" class="secondary" (click)="selectPerson(person)">Select</button></td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <h3>{{ selectedPerson ? 'Edit selected person' : 'Create person' }}</h3>
      <div class="grid two">
        <label>
          Full name
          <input [(ngModel)]="personForm.fullName" />
        </label>
        <label>
          Identification
          <input [(ngModel)]="personForm.identificationNumber" />
        </label>
        <label>
          Age
          <input [(ngModel)]="personForm.age" type="number" min="0" max="120" />
        </label>
        <label>
          Gender
          <select [(ngModel)]="personForm.gender">
            @for (gender of genders; track gender.value) {
              <option [ngValue]="gender.value">{{ gender.label }}</option>
            }
          </select>
        </label>
      </div>

      <div class="actions split">
        <button type="button" (click)="createPerson()" [disabled]="busy || !token">Create</button>
        <button type="button" (click)="updatePerson()" [disabled]="busy || !token || !selectedPerson">Update</button>
        <button
          type="button"
          class="secondary"
          (click)="toggleStatus(!selectedPerson!.isActive)"
          [disabled]="busy || !token || !selectedPerson"
        >
          {{ selectedPerson?.isActive ? 'Set inactive' : 'Set active' }}
        </button>
      </div>
    </article>

    <article class="panel">
      <h2>Attribute Definitions</h2>

      <label class="inline-checkbox">
        <input type="checkbox" [(ngModel)]="includeInactiveDefinitions" />
        Include inactive definitions
      </label>

      <div class="actions">
        <button type="button" class="secondary" (click)="loadDefinitions()" [disabled]="busy || !token">Refresh definitions</button>
      </div>

      <div class="grid two">
        <label>
          Key
          <input [(ngModel)]="newDefinition.key" placeholder="snake_case" />
        </label>
        <label>
          Display name
          <input [(ngModel)]="newDefinition.displayName" />
        </label>
        <label>
          Data type
          <select [(ngModel)]="newDefinition.dataType">
            @for (type of attributeTypes; track type.value) {
              <option [ngValue]="type.value">{{ type.label }}</option>
            }
          </select>
        </label>
        <label class="inline-checkbox spaced">
          <input type="checkbox" [(ngModel)]="newDefinition.isFilterable" />
          Is filterable
        </label>
        <label class="span-two">
          Validation rules JSON
          <input [(ngModel)]="newDefinition.validationRulesJson" placeholder='{"maxLength": 200}' />
        </label>
      </div>

      <div class="actions">
        <button type="button" (click)="createDefinition()" [disabled]="busy || !token">Create definition</button>
      </div>

      <div class="definition-list">
        @for (def of definitions; track def.id) {
          <section class="definition-item">
            <header>
              <strong>{{ def.key }}</strong>
              <span class="muted">{{ typeName(def.dataType) }}</span>
            </header>
            <div class="grid two compact">
              <label>
                Display name
                <input [(ngModel)]="def.displayName" />
              </label>
              <label class="inline-checkbox spaced">
                <input type="checkbox" [(ngModel)]="def.isFilterable" />
                Filterable
              </label>
              <label class="inline-checkbox spaced">
                <input type="checkbox" [(ngModel)]="def.isActive" />
                Active
              </label>
              <label class="span-two">
                Validation rules JSON
                <input [(ngModel)]="def.validationRulesJson" />
              </label>
            </div>
            <div class="actions">
              <button type="button" class="secondary" (click)="updateDefinition(def)" [disabled]="busy || !token">Save</button>
            </div>
          </section>
        }
      </div>
    </article>
  </section>

  <section class="panel">
    <h2>AI Tools</h2>

    <div class="grid two">
      <label class="span-two">
        Condition text
        <input [(ngModel)]="conditionText" placeholder="e.g. diabetic with chronic hypertension" />
      </label>
    </div>

    <div class="actions split">
      <button type="button" class="secondary" (click)="normalizeCondition()" [disabled]="busy || !token">Normalize condition</button>
      <button type="button" class="secondary" (click)="applySuggestedAttributes()" [disabled]="busy || !token || !normalizedCondition || !selectedPerson">
        Apply suggested attributes
      </button>
      <button type="button" (click)="scoreSelectedPersonRisk()" [disabled]="busy || !token || !selectedPerson">Score selected person risk</button>
    </div>

    @if (normalizedCondition) {
      <div class="ai-card">
        <h3>Normalized Condition</h3>
        <p class="hint">
          <strong>{{ normalizedCondition.code }}</strong> · {{ normalizedCondition.label }} ·
          confidence {{ normalizedCondition.confidence | number: '1.0-3' }} · source {{ normalizedCondition.source }}
        </p>

        <p class="hint">Matched terms: {{ normalizedCondition.matchedTerms.length ? normalizedCondition.matchedTerms.join(', ') : 'none' }}</p>

        @if (normalizedCondition.suggestedAttributes.length) {
          <div class="ai-list">
            @for (item of normalizedCondition.suggestedAttributes; track item.key) {
              <p>
                <strong>{{ item.key }}</strong>:
                @if (item.boolValue !== null) {
                  <span>{{ item.boolValue }}</span>
                } @else if (item.stringValue !== null) {
                  <span>{{ item.stringValue }}</span>
                } @else if (item.numberValue !== null) {
                  <span>{{ item.numberValue }}</span>
                } @else if (item.dateValue !== null) {
                  <span>{{ item.dateValue }}</span>
                } @else {
                  <span>unset</span>
                }
              </p>
            }
          </div>
        } @else {
          <p class="hint">No suggested attributes returned.</p>
        }
      </div>
    }

    @if (riskScore) {
      <div
        class="ai-card risk-card"
        [class.risk-low]="isRiskBand(riskScore.band, 'low')"
        [class.risk-medium]="isRiskBand(riskScore.band, 'medium')"
        [class.risk-high]="isRiskBand(riskScore.band, 'high')"
      >
        <h3>Risk Score</h3>
        <p class="hint risk-summary">
          <strong>{{ riskScore.score }}</strong>
          <span
            class="risk-badge"
            [class.risk-low]="isRiskBand(riskScore.band, 'low')"
            [class.risk-medium]="isRiskBand(riskScore.band, 'medium')"
            [class.risk-high]="isRiskBand(riskScore.band, 'high')"
          >
            {{ riskBandLabel(riskScore.band) }}
          </span>
        </p>
        @if ((riskScore.reasons ?? []).length) {
          <ul class="reason-list">
            @for (reason of (riskScore.reasons ?? []); track reason) {
              <li>{{ reason }}</li>
            }
          </ul>
        } @else {
          <p class="hint">No reasons returned.</p>
        }
      </div>
    }
  </section>

  <section class="panel">
    <h2>Selected Person Attributes</h2>
    @if (!selectedPerson) {
      <p class="hint">Select a person to edit their attributes.</p>
    } @else {
      <p class="hint">Editing: {{ selectedPerson.fullName }}</p>

      <div class="attribute-grid">
        @for (attr of personAttributes; track attr.key) {
          <label>
            {{ attr.displayName }}
            <small>{{ attr.key }} · {{ typeName(attr.dataType) }}</small>

            @if (attr.dataType === 1) {
              <select [(ngModel)]="attr.boolValue">
                <option [ngValue]="null">Unset</option>
                <option [ngValue]="true">True</option>
                <option [ngValue]="false">False</option>
              </select>
            }

            @if (attr.dataType === 2 || attr.dataType === 5) {
              <input [(ngModel)]="attr.stringValue" />
            }

            @if (attr.dataType === 3) {
              <input [(ngModel)]="attr.numberValue" type="number" step="any" />
            }

            @if (attr.dataType === 4) {
              <input [(ngModel)]="attr.dateValue" type="date" />
            }
          </label>
        }
      </div>

      <div class="actions split">
        <button type="button" class="secondary" (click)="loadPersonAttributeForm()" [disabled]="busy || !token">Reload form</button>
        <button type="button" (click)="savePersonAttributes()" [disabled]="busy || !token">Save attributes</button>
      </div>
    }
  </section>
</main>
