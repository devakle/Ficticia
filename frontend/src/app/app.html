<main class="admin-page">
  <header class="topbar panel">
    <div>
      <p class="eyebrow">Ficticia</p>
      <h1>Consola de Administración</h1>
    </div>
    <div class="status">
      <span class="chip" [class.off]="!token">{{ token ? 'Autenticado' : 'Sin token' }}</span>
      <button type="button" class="secondary" (click)="toggleTheme()">
        {{ themeMode === 'dark' ? 'Modo claro' : 'Modo oscuro' }}
      </button>
      <button type="button" class="secondary" (click)="logout()" [disabled]="busy || !token">Limpiar token</button>
    </div>
  </header>

  <section class="panel auth-panel">
    <h2>Conexion</h2>
    <div class="grid three">
      <label>
        URL base de API
        <input [(ngModel)]="apiBaseUrl" placeholder="(vacio para proxy de Angular)" />
      </label>
      <label>
        Correo
        <input [(ngModel)]="email" placeholder="admin@ficticia.local" />
      </label>
      <label>
        Contrasena
        <input [(ngModel)]="password" type="password" placeholder="Admin123!" />
      </label>
    </div>
    <div class="actions">
      <button type="button" (click)="login()" [disabled]="busy">Iniciar sesion y cargar datos</button>
    </div>
  </section>

  <div class="toast-stack" aria-live="polite" aria-atomic="true">
    @for (note of notifications(); track note.id) {
      <article class="toast" [class.error]="note.type === 'error'">
        <p>{{ note.text }}</p>
        <button type="button" class="toast-close" (click)="dismissNotification(note.id)" aria-label="Cerrar notificacion">×</button>
      </article>
    }
  </div>

  <section class="layout-two">
    <article class="panel">
      <h2>Personas</h2>

      <div class="grid three">
        <label>
          Nombre
          <input [(ngModel)]="peopleSearch.name" />
        </label>
        <label>
          Identificacion
          <input [(ngModel)]="peopleSearch.identificationNumber" />
        </label>
        <label>
          Estado
          <select [(ngModel)]="peopleSearch.isActive">
            <option value="">Cualquiera</option>
            <option value="true">Activo</option>
            <option value="false">Inactivo</option>
          </select>
        </label>
      </div>

      <div class="grid four">
        <label>
          Edad minima
          <input [(ngModel)]="peopleSearch.minAge" type="number" min="0" max="120" />
        </label>
        <label>
          Edad maxima
          <input [(ngModel)]="peopleSearch.maxAge" type="number" min="0" max="120" />
        </label>
        <label>
          Pagina
          <input [(ngModel)]="peopleSearch.page" type="number" min="1" />
        </label>
        <label>
          Tamano de pagina
          <input [(ngModel)]="peopleSearch.pageSize" type="number" min="1" max="100" />
        </label>
      </div>

      <div class="dynamic-filters">
        <p class="hint">Filtros dinamicos (`attr.&lt;key&gt;`)</p>
        @for (filter of peopleSearch.dynamicFilters; track $index) {
          <div class="filter-row">
            <select [(ngModel)]="filter.key" (ngModelChange)="onDynamicFilterKeyChange($index, $event)">
              <option [ngValue]="''">Seleccionar atributo filtrable</option>
              @for (def of filterableDefinitions; track def.id) {
                <option [ngValue]="def.key">{{ def.displayName }}</option>
              }
            </select>
            @if (dynamicFilterType(filter) === 1) {
              <select [(ngModel)]="filter.value">
                <option [ngValue]="''">Si/No</option>
                <option [ngValue]="'true'">Si</option>
                <option [ngValue]="'false'">No</option>
              </select>
            } @else if (dynamicFilterType(filter) === 5 && dynamicFilterAllowedValues(filter).length > 0) {
              <select [(ngModel)]="filter.value">
                <option [ngValue]="''">Seleccionar valor</option>
                @for (allowedValue of dynamicFilterAllowedValues(filter); track allowedValue) {
                  <option [ngValue]="allowedValue">{{ allowedValue }}</option>
                }
              </select>
            } @else if (dynamicFilterType(filter) === 3) {
              <input [(ngModel)]="filter.value" type="number" step="any" [placeholder]="dynamicFilterValuePlaceholder(filter)" />
            } @else if (dynamicFilterType(filter) === 4) {
              <input [(ngModel)]="filter.value" type="date" [placeholder]="dynamicFilterValuePlaceholder(filter)" />
            } @else {
              <input [(ngModel)]="filter.value" [placeholder]="dynamicFilterValuePlaceholder(filter)" />
            }
            <small class="filter-key">{{ filter.key ? ('attr.' + filter.key) : 'sin seleccion' }}</small>
            <button type="button" class="secondary" (click)="clearDynamicFilterDefinition($index)" [disabled]="!filter.key">
              Limpiar
            </button>
            <button type="button" class="secondary" (click)="removeDynamicFilter($index)">Quitar</button>
          </div>
        }
      </div>

      <div class="actions split">
        <button type="button" class="secondary" (click)="addDynamicFilter()">Agregar filtro</button>
        <button type="button" (click)="searchPeople()" [disabled]="busy || !token">Buscar</button>
      </div>

      <p class="hint">Total: {{ totalPeople }}</p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>ID</th>
              <th>Edad</th>
              <th>Genero</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (person of people; track person.id) {
              <tr [class.selected]="selectedPerson?.id === person.id">
                <td>{{ person.fullName }}</td>
                <td>{{ person.identificationNumber }}</td>
                <td>{{ person.age }}</td>
                <td>{{ genders[person.gender]?.label }}</td>
                <td>{{ person.isActive ? 'Activo' : 'Inactivo' }}</td>
                <td><button type="button" class="secondary" (click)="selectPerson(person)">Seleccionar</button></td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <h3>{{ selectedPerson ? 'Editar persona seleccionada' : 'Crear persona' }}</h3>
      <div class="grid two">
        <label>
          Nombre completo
          <input [(ngModel)]="personForm.fullName" />
        </label>
        <label>
          Identificacion
          <input [(ngModel)]="personForm.identificationNumber" />
        </label>
        <label>
          Edad
          <input [(ngModel)]="personForm.age" type="number" min="0" max="120" />
        </label>
        <label>
          Genero
          <select [(ngModel)]="personForm.gender">
            @for (gender of genders; track gender.value) {
              <option [ngValue]="gender.value">{{ gender.label }}</option>
            }
          </select>
        </label>
      </div>

      <div class="actions split">
        <button type="button" (click)="createPerson()" [disabled]="busy || !token">Crear</button>
        <button type="button" (click)="updatePerson()" [disabled]="busy || !token || !selectedPerson">Actualizar</button>
        <button
          type="button"
          class="secondary"
          (click)="toggleStatus(!selectedPerson!.isActive)"
          [disabled]="busy || !token || !selectedPerson"
        >
          {{ selectedPerson?.isActive ? 'Marcar inactiva' : 'Marcar activa' }}
        </button>
      </div>
    </article>

    <article class="panel">
      <h2>Definiciones de Atributos</h2>

      <label class="inline-checkbox">
        <input type="checkbox" [(ngModel)]="includeInactiveDefinitions" />
        Incluir definiciones inactivas
      </label>

      <div class="actions">
        <button type="button" class="secondary" (click)="loadDefinitions()" [disabled]="busy || !token">Actualizar definiciones</button>
      </div>

      <div class="grid two">
        <label>
          Clave
          <input [(ngModel)]="newDefinition.key" placeholder="snake_case" />
        </label>
        <label>
          Nombre visible
          <input [(ngModel)]="newDefinition.displayName" />
        </label>
        <label>
          Tipo de dato
          <select [(ngModel)]="newDefinition.dataType">
            @for (type of attributeTypes; track type.value) {
              <option [ngValue]="type.value">{{ type.label }}</option>
            }
          </select>
        </label>
        <label class="inline-checkbox spaced">
          <input type="checkbox" [(ngModel)]="newDefinition.isFilterable" />
          Es filtrable
        </label>
        <div class="rule-editor span-two">
          <p class="rule-title">Reglas de validacion</p>
          <label class="inline-checkbox">
            <input type="checkbox" [(ngModel)]="newDefinitionRules.required" />
            Requerido
          </label>

          @if (newDefinition.dataType === 2) {
            <div class="grid two compact">
              <label>
                Maximo de caracteres
                <input [(ngModel)]="newDefinitionRules.maxLength" type="number" min="1" />
              </label>
              <label>
                Regex
                <input [(ngModel)]="newDefinitionRules.regex" placeholder="^[A-Za-z ]+$" />
              </label>
            </div>
          }

          @if (newDefinition.dataType === 3) {
            <div class="grid two compact">
              <label>
                Minimo
                <input [(ngModel)]="newDefinitionRules.min" type="number" step="any" />
              </label>
              <label>
                Maximo
                <input [(ngModel)]="newDefinitionRules.max" type="number" step="any" />
              </label>
            </div>
          }

          @if (newDefinition.dataType === 4) {
            <div class="grid two compact">
              <label>
                Fecha minima
                <input [(ngModel)]="newDefinitionRules.minDate" type="date" />
              </label>
              <label>
                Fecha maxima
                <input [(ngModel)]="newDefinitionRules.maxDate" type="date" />
              </label>
            </div>
          }

          @if (newDefinition.dataType === 5) {
            <label>
              Valores permitidos (separados por coma o salto de linea)
              <textarea [(ngModel)]="newDefinitionRules.allowedValuesText" rows="2" placeholder="hipertension, diabetes, asma"></textarea>
            </label>
          }

          <p class="rule-json-preview"><code>{{ definitionRulesForNewPreview() }}</code></p>
        </div>
      </div>

      <div class="actions">
        <button type="button" (click)="createDefinition()" [disabled]="busy || !token">Crear definicion</button>
      </div>

      <div class="definition-list">
        @for (def of definitions; track def.id) {
          <section class="definition-item">
            <header>
              <strong>{{ def.key }}</strong>
              <span class="muted">{{ typeName(def.dataType) }}</span>
            </header>
            <div class="grid two compact">
              <label>
                Nombre visible
                <input [(ngModel)]="def.displayName" />
              </label>
              <label class="inline-checkbox spaced">
                <input type="checkbox" [(ngModel)]="def.isFilterable" />
                Filtrable
              </label>
              <label class="inline-checkbox spaced">
                <input type="checkbox" [(ngModel)]="def.isActive" />
                Activa
              </label>
              <div class="rule-editor span-two">
                <p class="rule-title">Reglas de validacion</p>
                <label class="inline-checkbox">
                  <input
                    type="checkbox"
                    [(ngModel)]="definitionRulesDraft(def.id, def.dataType, def.validationRulesJson).required"
                  />
                  Requerido
                </label>

                @if (def.dataType === 2) {
                  <div class="grid two compact">
                    <label>
                      Maximo de caracteres
                      <input
                        [(ngModel)]="definitionRulesDraft(def.id, def.dataType, def.validationRulesJson).maxLength"
                        type="number"
                        min="1"
                      />
                    </label>
                    <label>
                      Regex
                      <input
                        [(ngModel)]="definitionRulesDraft(def.id, def.dataType, def.validationRulesJson).regex"
                        placeholder="^[A-Za-z ]+$"
                      />
                    </label>
                  </div>
                }

                @if (def.dataType === 3) {
                  <div class="grid two compact">
                    <label>
                      Minimo
                      <input
                        [(ngModel)]="definitionRulesDraft(def.id, def.dataType, def.validationRulesJson).min"
                        type="number"
                        step="any"
                      />
                    </label>
                    <label>
                      Maximo
                      <input
                        [(ngModel)]="definitionRulesDraft(def.id, def.dataType, def.validationRulesJson).max"
                        type="number"
                        step="any"
                      />
                    </label>
                  </div>
                }

                @if (def.dataType === 4) {
                  <div class="grid two compact">
                    <label>
                      Fecha minima
                      <input
                        [(ngModel)]="definitionRulesDraft(def.id, def.dataType, def.validationRulesJson).minDate"
                        type="date"
                      />
                    </label>
                    <label>
                      Fecha maxima
                      <input
                        [(ngModel)]="definitionRulesDraft(def.id, def.dataType, def.validationRulesJson).maxDate"
                        type="date"
                      />
                    </label>
                  </div>
                }

                @if (def.dataType === 5) {
                  <label>
                    Valores permitidos (separados por coma o salto de linea)
                    <textarea
                      [(ngModel)]="definitionRulesDraft(def.id, def.dataType, def.validationRulesJson).allowedValuesText"
                      rows="2"
                      placeholder="hipertension, diabetes, asma"
                    ></textarea>
                  </label>
                }

                <p class="rule-json-preview"><code>{{ definitionRulesForPreview(def) }}</code></p>
              </div>
            </div>
            <div class="actions">
              <button type="button" class="secondary" (click)="updateDefinition(def)" [disabled]="busy || !token">Guardar</button>
            </div>
          </section>
        }
      </div>
    </article>
  </section>

  <section class="panel">
    <h2>Herramientas de IA</h2>

    <div class="grid two">
      <label class="span-two">
        Texto de condicion
        <input [(ngModel)]="conditionText" placeholder="ej. diabetico con hipertension cronica" />
      </label>
    </div>

    <div class="actions split">
      <button type="button" class="secondary" (click)="normalizeCondition()" [disabled]="busy || !token">Normalizar condicion</button>
      <button type="button" class="secondary" (click)="applySuggestedAttributes()" [disabled]="busy || !token || !normalizedCondition || !selectedPerson">
        Aplicar atributos sugeridos
      </button>
      <button type="button" (click)="scoreSelectedPersonRisk()" [disabled]="busy || !token || !selectedPerson">Calcular riesgo de la persona seleccionada</button>
    </div>

    @if (normalizedCondition) {
      <div class="ai-card">
        <h3>Condicion Normalizada</h3>
        <p class="hint">
          <strong>{{ normalizedCondition.code }}</strong> · {{ normalizedCondition.label }} ·
          confianza {{ normalizedCondition.confidence | number: '1.0-3' }} · fuente {{ normalizedCondition.source }}
        </p>

        <p class="hint">Terminos detectados: {{ normalizedCondition.matchedTerms.length ? normalizedCondition.matchedTerms.join(', ') : 'ninguno' }}</p>

        @if (normalizedCondition.suggestedAttributes.length) {
          <div class="ai-list">
            @for (item of normalizedCondition.suggestedAttributes; track item.key) {
              <p>
                <strong>{{ item.key }}</strong>:
                @if (item.boolValue !== null) {
                  <span>{{ item.boolValue ? 'Sí' : 'No' }}</span>
                } @else if (item.stringValue !== null) {
                  <span>{{ item.stringValue }}</span>
                } @else if (item.numberValue !== null) {
                  <span>{{ item.numberValue }}</span>
                } @else if (item.dateValue !== null) {
                  <span>{{ item.dateValue }}</span>
                } @else {
                  <span>sin definir</span>
                }
              </p>
            }
          </div>
        } @else {
          <p class="hint">No se devolvieron atributos sugeridos.</p>
        }
      </div>
    }

    @if (riskScore) {
      <div
        class="ai-card risk-card"
        [class.risk-low]="isRiskBand(riskScore.band, 'low')"
        [class.risk-medium]="isRiskBand(riskScore.band, 'medium')"
        [class.risk-high]="isRiskBand(riskScore.band, 'high')"
      >
        <h3>Puntaje de Riesgo</h3>
        <p class="hint risk-summary">
          <strong>{{ riskScore.score }}</strong>
          <span
            class="risk-badge"
            [class.risk-low]="isRiskBand(riskScore.band, 'low')"
            [class.risk-medium]="isRiskBand(riskScore.band, 'medium')"
            [class.risk-high]="isRiskBand(riskScore.band, 'high')"
          >
            {{ riskBandLabel(riskScore.band) }}
          </span>
        </p>
        @if ((riskScore.reasons ?? []).length) {
          <ul class="reason-list">
            @for (reason of (riskScore.reasons ?? []); track reason) {
              <li>{{ reason }}</li>
            }
          </ul>
        } @else {
          <p class="hint">No se devolvieron razones.</p>
        }
      </div>
    }
  </section>

  <section class="panel">
    <h2>Atributos de la Persona Seleccionada</h2>
    @if (!selectedPerson) {
      <p class="hint">Selecciona una persona para editar sus atributos.</p>
    } @else {
      <p class="hint">Editando: {{ selectedPerson.fullName }}</p>

      <div class="attribute-grid">
        @for (attr of personAttributes; track attr.key) {
          <label>
            {{ attr.displayName }}
            <small>{{ attr.key }} · {{ typeName(attr.dataType) }}</small>

            @if (attr.dataType === 1) {
              <select [(ngModel)]="attr.boolValue">
                <option [ngValue]="null">Sin definir</option>
                <option [ngValue]="true">Sí</option>
                <option [ngValue]="false">No</option>
              </select>
            }

            @if (attr.dataType === 2 || attr.dataType === 5) {
              <input [(ngModel)]="attr.stringValue" />
            }

            @if (attr.dataType === 3) {
              <input [(ngModel)]="attr.numberValue" type="number" step="any" />
            }

            @if (attr.dataType === 4) {
              <input [(ngModel)]="attr.dateValue" type="date" />
            }
          </label>
        }
      </div>

      <div class="actions split">
        <button type="button" class="secondary" (click)="loadPersonAttributeForm()" [disabled]="busy || !token">Recargar formulario</button>
        <button type="button" (click)="savePersonAttributes()" [disabled]="busy || !token">Guardar atributos</button>
      </div>
    }
  </section>
</main>
