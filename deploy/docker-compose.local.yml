services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: ficticia-sql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${SA_PASSWORD}"
    ports:
      - "1433:1433"
    volumes:
      - sql_data:/var/opt/mssql

  redis:
    image: redis:7-alpine
    container_name: ficticia-redis
    restart: unless-stopped

  api:
    build:
      context: ..
      dockerfile: backend/Dockerfile
    container_name: ficticia-api
    environment:
      ASPNETCORE_ENVIRONMENT: "Production"
      ConnectionStrings__PeopleDb: "Server=sqlserver,1433;Database=FicticiaPeople;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;"
      ConnectionStrings__IdentityDb: "Server=sqlserver,1433;Database=FicticiaIdentity;User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=True;"
      Jwt__Key: "${JWT_KEY}"
      Jwt__Issuer: "Ficticia.Api"
      Jwt__Audience: "Ficticia.Web"
      Jwt__ExpiresMinutes: "60"
      Redis__ConnectionString: "redis:6379"
      OpenAI__ApiKey: "${OPENAI_API_KEY}"
    depends_on:
      - sqlserver
      - redis
    ports:
      - "8080:8080"
    restart: unless-stopped

  web:
    build:
      context: ..
      dockerfile: frontend/Dockerfile
    container_name: ficticia-web
    depends_on:
      - api
    ports:
      - "80:80"
    restart: unless-stopped

  ngrok:
    image: ngrok/ngrok:latest
    container_name: ficticia-ngrok
    command:
      - "http"
      - "--pooling-enabled"
      - "web:80"
    environment:
      NGROK_AUTHTOKEN: "${NGROK_AUTHTOKEN}"
    depends_on:
      - web
    restart: unless-stopped
    profiles:
      - ngrok

volumes:
  sql_data:
